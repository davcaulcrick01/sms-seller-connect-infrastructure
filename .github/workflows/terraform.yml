name: 'SMS Seller Connect - Terraform CI/CD Pipeline'

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      action:
        description: 'Choose action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
          - format
          - redeploy
          - verify-secrets
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  # Terraform Configuration
  TF_VERSION: '1.5.7'
  TF_WORKING_DIR: './modules/ec2'
  
  # AWS Configuration
  AWS_REGION: 'us-east-1'
  AWS_ACCOUNT_ID: '522814698925'
  
  # Backend Configuration
  STATE_BUCKET: 'greyzone-terraform-state'
  LOCK_TABLE: 'terraform-locks'
  STATE_KEY: 'sms-seller-connect/ec2/terraform.tfstate'
  
  # Application Configuration
  PROJECT_NAME: 'sms-seller-connect'
  ECR_REPOSITORY: '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend'
  DOMAIN_NAME: 'typerelations.com'
  SMS_FRONTEND_DOMAIN: 'sms.typerelations.com'
  SMS_API_DOMAIN: 'api.sms.typerelations.com'
  
  # Environment Selection
  ENVIRONMENT: ${{ github.event.inputs.environment || 'prod' }}

jobs:
  format:
    name: 'üé® Auto-Format Terraform'
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' || 
      github.event_name == 'pull_request' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'format')
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Auto-Format Terraform Files
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üé® Auto-formatting Terraform files..."
        
        # Format all terraform files
        terraform fmt -recursive
        
        # Check if any files were changed
        if [[ -n $(git status --porcelain) ]]; then
          echo "‚úÖ Terraform files have been auto-formatted"
          
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add and commit changes
          git add .
          git commit -m "üé® Auto-format Terraform files [skip ci]"
          
          # Push changes
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git push origin HEAD:${{ github.head_ref }}
          else
            git push
          fi
          
          echo "üì§ Formatted files committed and pushed"
        else
          echo "‚ÑπÔ∏è All Terraform files are already properly formatted"
        fi

  validate:
    name: 'üîç Validate Terraform'
    runs-on: ubuntu-latest
    needs: [format]
    if: always()
    
    outputs:
      terraform-valid: ${{ steps.validate.outputs.terraform-valid }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Format Check
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üé® Verifying Terraform formatting..."
        terraform fmt -check -recursive
        echo "‚úÖ All Terraform files are properly formatted"

    - name: Terraform Init
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîß Initializing Terraform..."
        terraform init -backend=false

    - name: Terraform Validate
      id: validate
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "‚úÖ Validating Terraform configuration..."
        terraform validate
        echo "terraform-valid=true" >> $GITHUB_OUTPUT

    - name: Security Scan with tfsec
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîí Running security scan with tfsec..."
        
        # Install tfsec
        curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
        
        # Run tfsec with custom configuration
        ./tfsec . --format json --out tfsec-results.json || true
        
        # Display results
        if [ -f tfsec-results.json ]; then
          echo "üìä Security scan results:"
          cat tfsec-results.json | jq '.results[] | select(.severity == "HIGH" or .severity == "CRITICAL") | {rule_id: .rule_id, severity: .severity, description: .description}' || echo "No high/critical issues found"
        fi

  plan:
    name: 'üìã Plan Infrastructure'
    runs-on: ubuntu-latest
    needs: [format, validate]
    if: needs.validate.outputs.terraform-valid == 'true'
    
    outputs:
      plan-status: ${{ steps.plan.outputs.status }}
      has-changes: ${{ steps.plan.outputs.has-changes }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Verify Backend Health
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîç Verifying backend health..."
        
        # Check S3 bucket
        if aws s3 ls "s3://${{ env.STATE_BUCKET }}" > /dev/null 2>&1; then
          echo "‚úÖ S3 bucket accessible"
        else
          echo "‚ùå S3 bucket not accessible"
          exit 1
        fi
        
        # Check DynamoDB table
        if aws dynamodb describe-table --table-name "${{ env.LOCK_TABLE }}" > /dev/null 2>&1; then
          echo "‚úÖ DynamoDB lock table exists"
        else
          echo "‚ùå DynamoDB lock table missing"
          exit 1
        fi

    - name: Terraform Init with Backend
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîß Initializing Terraform with S3 backend..."
        terraform init -reconfigure \
          -backend-config="bucket=${{ env.STATE_BUCKET }}" \
          -backend-config="key=${{ env.STATE_KEY }}" \
          -backend-config="region=${{ env.AWS_REGION }}" \
          -backend-config="dynamodb_table=${{ env.LOCK_TABLE }}" \
          -backend-config="encrypt=true"

    - name: Check and Handle State Lock
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîç Checking for existing state locks..."
        
        # Function to check if lock is stale (older than 15 minutes)
        check_stale_lock() {
          local lock_time=$1
          local current_time=$(date -u +%s)
          local lock_timestamp=$(date -d "$lock_time" +%s 2>/dev/null || echo "0")
          local age=$((current_time - lock_timestamp))
          
          # If lock is older than 15 minutes (900 seconds), consider it stale
          if [ $age -gt 900 ]; then
            return 0  # stale
          else
            return 1  # not stale
          fi
        }
        
        # Try to get state info to check for locks
        set +e
        terraform refresh -input=false > /dev/null 2>&1
        refresh_exit_code=$?
        set -e
        
        if [ $refresh_exit_code -eq 1 ]; then
          echo "üîí State lock detected, checking if it's stale..."
          
          # Try to get lock info
          lock_output=$(terraform plan -input=false 2>&1 || true)
          
          if echo "$lock_output" | grep -q "Lock Info:"; then
            lock_id=$(echo "$lock_output" | grep "ID:" | awk '{print $2}')
            lock_time=$(echo "$lock_output" | grep "Created:" | sed 's/.*Created: *\(.*\) UTC.*/\1/')
            lock_who=$(echo "$lock_output" | grep "Who:" | awk '{print $2}')
            
            echo "üîç Lock details:"
            echo "  ID: $lock_id"
            echo "  Created: $lock_time"
            echo "  Who: $lock_who"
            
            if check_stale_lock "$lock_time"; then
              echo "‚ö†Ô∏è Lock is stale (older than 15 minutes), force unlocking..."
              terraform force-unlock -force "$lock_id"
              echo "‚úÖ Stale lock removed successfully"
            else
              echo "‚ùå Lock is recent, operation is likely in progress"
              echo "üïê Waiting 60 seconds for operation to complete..."
              sleep 60
              
              # Check again after waiting
              set +e
              terraform refresh -input=false > /dev/null 2>&1
              second_check=$?
              set -e
              
              if [ $second_check -eq 1 ]; then
                echo "üîí Lock still exists after waiting, force unlocking..."
                terraform force-unlock -force "$lock_id" || true
                echo "‚úÖ Lock forcefully removed"
              else
                echo "‚úÖ Lock cleared automatically"
              fi
            fi
          fi
        else
          echo "‚úÖ No state lock detected"
        fi

    - name: Set Terraform Environment Variables
      working-directory: ${{ env.TF_WORKING_DIR }}
      env:
        # Basic Configuration
        TF_VAR_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_environment: ${{ env.ENVIRONMENT }}
        TF_VAR_project_name: ${{ vars.PROJECT_NAME || 'sms-seller-connect' }}
        
        # EC2 Configuration
        TF_VAR_ami_id: ${{ vars.AMI_ID || 'ami-0c02fb55956c7d316' }}
        TF_VAR_instance_type: ${{ vars.INSTANCE_TYPE || 't2.micro' }}
        TF_VAR_key_name: ${{ vars.KEY_NAME || 'sms-seller-connect-key' }}
        TF_VAR_instance_name: ${{ vars.INSTANCE_NAME || 'sms-seller-connect' }}
        
        # Networking Configuration
        TF_VAR_vpc_name: ${{ vars.VPC_NAME || 'Grey-VPC' }}
        TF_VAR_subnet_name: ${{ vars.SUBNET_NAME || 'Grey-private-subnet' }}
        TF_VAR_subnet_name_b: ${{ vars.SUBNET_NAME_B || 'Grey-public-subnet' }}
        TF_VAR_admin_ssh_cidr: ${{ vars.ADMIN_SSH_CIDR || '0.0.0.0/0' }}
        
        # S3 Configuration
        TF_VAR_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_bucket_acl: ${{ vars.S3_ACL || 'private' }}
        
        # Container Configuration
        TF_VAR_ecr_repo_url: ${{ vars.ECR_REPO_URL || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend' }}
        TF_VAR_container_tag: ${{ vars.CONTAINER_TAG || 'latest' }}
        TF_VAR_app_port: ${{ vars.APP_PORT || '8900' }}
        TF_VAR_backend_image: ${{ vars.BACKEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend:latest' }}
        TF_VAR_frontend_image: ${{ vars.FRONTEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-frontend:latest' }}
        
        # Domain Configuration
        TF_VAR_domain_zone_name: ${{ vars.DOMAIN_ZONE_NAME || 'typerelations.com' }}
        TF_VAR_domain_name: ${{ vars.DOMAIN_NAME || 'typerelations.com' }}
        TF_VAR_sms_frontend_domain: ${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_sms_api_domain: ${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        
        # Monitoring
        TF_VAR_alert_email: ${{ vars.ALERT_EMAIL || 'dcaulcrick01@gmail.com' }}
        
        # Secrets
        TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        TF_VAR_db_host: ${{ secrets.DB_HOST }}
        TF_VAR_db_user: ${{ secrets.DB_USER }}
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_flask_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_jwt_secret_key: ${{ secrets.JWT_SECRET_KEY }}
        TF_VAR_twilio_account_sid: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TF_VAR_twilio_auth_token: ${{ secrets.TWILIO_AUTH_TOKEN }}
        TF_VAR_twilio_phone_number: ${{ secrets.TWILIO_PHONE_NUMBER }}
        TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        TF_VAR_sendgrid_api_key: ${{ secrets.SENDGRID_API_KEY }}
        TF_VAR_ngrok_auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}
        TF_VAR_hot_lead_sms_recipients: ${{ secrets.HOT_LEAD_SMS_RECIPIENTS }}
        
        # Application URLs
        TF_VAR_database_url: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:5437/sms_blast
        TF_VAR_twilio_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/webhooks/sms
        TF_VAR_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_frontend_url: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        
        # Additional Configuration
        TF_VAR_db_port: ${{ vars.DB_PORT || '5437' }}
        TF_VAR_db_name: ${{ vars.DB_NAME || 'sms_blast' }}
        TF_VAR_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_openai_model: ${{ vars.OPENAI_MODEL || 'gpt-3.5-turbo' }}
        TF_VAR_openai_temperature: ${{ vars.OPENAI_TEMPERATURE || '0.7' }}
        TF_VAR_sendgrid_from_email: ${{ vars.SENDGRID_FROM_EMAIL || 'noreply@typerelations.com' }}
        TF_VAR_aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_aws_default_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_backend_port: ${{ vars.BACKEND_PORT || '8900' }}
        TF_VAR_frontend_port: ${{ vars.FRONTEND_PORT || '3000' }}
        TF_VAR_vite_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_backend_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_allowed_origins: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_ngrok_port: ${{ vars.NGROK_PORT || '4040' }}
        TF_VAR_ngrok_url: ${{ vars.NGROK_URL || '' }}
        TF_VAR_ngrok_subdomain: ${{ vars.NGROK_SUBDOMAIN || '' }}
        TF_VAR_log_level: ${{ vars.LOG_LEVEL || 'INFO' }}
        TF_VAR_hot_lead_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/alerts
        TF_VAR_hot_lead_email_recipients: ${{ vars.HOT_LEAD_EMAIL_RECIPIENTS || 'dcaulcrick01@gmail.com' }}
        TF_VAR_rate_limit_per_minute: ${{ vars.RATE_LIMIT_PER_MINUTE || '100' }}
        TF_VAR_rate_limit_burst: ${{ vars.RATE_LIMIT_BURST || '200' }}
        TF_VAR_session_timeout_minutes: ${{ vars.SESSION_TIMEOUT_MINUTES || '60' }}
        TF_VAR_remember_me_days: ${{ vars.REMEMBER_ME_DAYS || '30' }}
        TF_VAR_max_file_size_mb: ${{ vars.MAX_FILE_SIZE_MB || '10' }}
        TF_VAR_allowed_file_types: ${{ vars.ALLOWED_FILE_TYPES || 'csv,xlsx,txt' }}
        TF_VAR_carrental_frontend_domain: ''
        TF_VAR_carrental_api_domain: ''
        TF_VAR_subnet_id: ''
        TF_VAR_route53_zone_id: ''
        TF_VAR_alb_dns_name: ''
        TF_VAR_alb_zone_id: ''
      run: |
        echo "üîß Setting Terraform environment variables from GitHub secrets..."
        echo "‚úÖ All Terraform environment variables configured using GitHub Actions env context"
        echo "üìä Environment: ${{ env.ENVIRONMENT }}"
        echo "üîí Secrets and variables loaded as TF_VAR_* environment variables"
        
        # Verify some key variables are set
        echo "üîç Verifying key environment variables..."
        echo "Region: ${TF_VAR_region:-NOT_SET}"
        echo "Environment: ${TF_VAR_environment:-NOT_SET}"
        echo "Project: ${TF_VAR_project_name:-NOT_SET}"
        echo "Instance Type: ${TF_VAR_instance_type:-NOT_SET}"
        
        # Verify problematic tag variables are not set
        echo "üîç Verifying tag variables are not set..."
        if [ -n "${TF_VAR_tags:-}" ]; then
          echo "‚ö†Ô∏è WARNING: TF_VAR_tags is set: ${TF_VAR_tags}"
        else
          echo "‚úÖ TF_VAR_tags is not set (good)"
        fi
        
        if [ -n "${TF_VAR_common_tags:-}" ]; then
          echo "‚ö†Ô∏è WARNING: TF_VAR_common_tags is set: ${TF_VAR_common_tags}"
        else
          echo "‚úÖ TF_VAR_common_tags is not set (good)"
        fi

    - name: Set Boolean Environment Variables
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîß Setting boolean environment variables for Terraform..."
        
        # Convert string boolean values to proper booleans
        # GitHub Actions passes booleans as strings, so we need to convert them
        
        # Set use_default_vpc
        if [ "${{ vars.USE_DEFAULT_VPC || 'true' }}" = "true" ]; then
          echo "TF_VAR_use_default_vpc=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_use_default_vpc=false" >> $GITHUB_ENV
        fi
        
        # Set s3_force_destroy
        if [ "${{ vars.S3_FORCE_DESTROY || 'false' }}" = "true" ]; then
          echo "TF_VAR_s3_force_destroy=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_s3_force_destroy=false" >> $GITHUB_ENV
        fi
        
        # Set use_postgres
        if [ "${{ vars.USE_POSTGRES || 'true' }}" = "true" ]; then
          echo "TF_VAR_use_postgres=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_use_postgres=false" >> $GITHUB_ENV
        fi
        
        # Set start_ngrok
        if [ "${{ vars.START_NGROK || 'true' }}" = "true" ]; then
          echo "TF_VAR_start_ngrok=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_start_ngrok=false" >> $GITHUB_ENV
        fi
        
        # Set debug
        if [ "${{ vars.DEBUG || 'true' }}" = "true" ]; then
          echo "TF_VAR_debug=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_debug=false" >> $GITHUB_ENV
        fi
        
        # Set enable_carrental_domain (hardcoded to false)
        echo "TF_VAR_enable_carrental_domain=false" >> $GITHUB_ENV
        
        echo "‚úÖ Boolean environment variables set successfully!"

    - name: Terraform Plan
      id: plan
      working-directory: ${{ env.TF_WORKING_DIR }}
      env:
        # Basic Configuration
        TF_VAR_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_environment: ${{ env.ENVIRONMENT }}
        TF_VAR_project_name: ${{ vars.PROJECT_NAME || 'sms-seller-connect' }}
        
        # EC2 Configuration
        TF_VAR_ami_id: ${{ vars.AMI_ID || 'ami-0c02fb55956c7d316' }}
        TF_VAR_instance_type: ${{ vars.INSTANCE_TYPE || 't2.micro' }}
        TF_VAR_key_name: ${{ vars.KEY_NAME || 'sms-seller-connect-key' }}
        TF_VAR_instance_name: ${{ vars.INSTANCE_NAME || 'sms-seller-connect' }}
        
        # Networking Configuration
        TF_VAR_vpc_name: ${{ vars.VPC_NAME || 'Grey-VPC' }}
        TF_VAR_subnet_name: ${{ vars.SUBNET_NAME || 'Grey-private-subnet' }}
        TF_VAR_subnet_name_b: ${{ vars.SUBNET_NAME_B || 'Grey-public-subnet' }}
        TF_VAR_admin_ssh_cidr: ${{ vars.ADMIN_SSH_CIDR || '0.0.0.0/0' }}
        
        # S3 Configuration
        TF_VAR_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_bucket_acl: ${{ vars.S3_ACL || 'private' }}
        
        # Container Configuration
        TF_VAR_ecr_repo_url: ${{ vars.ECR_REPO_URL || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend' }}
        TF_VAR_container_tag: ${{ vars.CONTAINER_TAG || 'latest' }}
        TF_VAR_app_port: ${{ vars.APP_PORT || '8900' }}
        TF_VAR_backend_image: ${{ vars.BACKEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend:latest' }}
        TF_VAR_frontend_image: ${{ vars.FRONTEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-frontend:latest' }}
        
        # Domain Configuration
        TF_VAR_domain_zone_name: ${{ vars.DOMAIN_ZONE_NAME || 'typerelations.com' }}
        TF_VAR_domain_name: ${{ vars.DOMAIN_NAME || 'typerelations.com' }}
        TF_VAR_sms_frontend_domain: ${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_sms_api_domain: ${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        
        # Monitoring
        TF_VAR_alert_email: ${{ vars.ALERT_EMAIL || 'dcaulcrick01@gmail.com' }}
        
        # Secrets
        TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        TF_VAR_db_host: ${{ secrets.DB_HOST }}
        TF_VAR_db_user: ${{ secrets.DB_USER }}
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_flask_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_jwt_secret_key: ${{ secrets.JWT_SECRET_KEY }}
        TF_VAR_twilio_account_sid: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TF_VAR_twilio_auth_token: ${{ secrets.TWILIO_AUTH_TOKEN }}
        TF_VAR_twilio_phone_number: ${{ secrets.TWILIO_PHONE_NUMBER }}
        TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        TF_VAR_sendgrid_api_key: ${{ secrets.SENDGRID_API_KEY }}
        TF_VAR_ngrok_auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}
        TF_VAR_hot_lead_sms_recipients: ${{ secrets.HOT_LEAD_SMS_RECIPIENTS }}
        
        # Application URLs
        TF_VAR_database_url: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:5437/sms_blast
        TF_VAR_twilio_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/webhooks/sms
        TF_VAR_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_frontend_url: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        
        # Additional Configuration
        TF_VAR_db_port: ${{ vars.DB_PORT || '5437' }}
        TF_VAR_db_name: ${{ vars.DB_NAME || 'sms_blast' }}
        TF_VAR_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_openai_model: ${{ vars.OPENAI_MODEL || 'gpt-3.5-turbo' }}
        TF_VAR_openai_temperature: ${{ vars.OPENAI_TEMPERATURE || '0.7' }}
        TF_VAR_sendgrid_from_email: ${{ vars.SENDGRID_FROM_EMAIL || 'noreply@typerelations.com' }}
        TF_VAR_aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_aws_default_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_backend_port: ${{ vars.BACKEND_PORT || '8900' }}
        TF_VAR_frontend_port: ${{ vars.FRONTEND_PORT || '3000' }}
        TF_VAR_vite_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_backend_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_allowed_origins: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_ngrok_port: ${{ vars.NGROK_PORT || '4040' }}
        TF_VAR_ngrok_url: ${{ vars.NGROK_URL || '' }}
        TF_VAR_ngrok_subdomain: ${{ vars.NGROK_SUBDOMAIN || '' }}
        TF_VAR_log_level: ${{ vars.LOG_LEVEL || 'INFO' }}
        TF_VAR_hot_lead_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/alerts
        TF_VAR_hot_lead_email_recipients: ${{ vars.HOT_LEAD_EMAIL_RECIPIENTS || 'dcaulcrick01@gmail.com' }}
        TF_VAR_rate_limit_per_minute: ${{ vars.RATE_LIMIT_PER_MINUTE || '100' }}
        TF_VAR_rate_limit_burst: ${{ vars.RATE_LIMIT_BURST || '200' }}
        TF_VAR_session_timeout_minutes: ${{ vars.SESSION_TIMEOUT_MINUTES || '60' }}
        TF_VAR_remember_me_days: ${{ vars.REMEMBER_ME_DAYS || '30' }}
        TF_VAR_max_file_size_mb: ${{ vars.MAX_FILE_SIZE_MB || '10' }}
        TF_VAR_allowed_file_types: ${{ vars.ALLOWED_FILE_TYPES || 'csv,xlsx,txt' }}
        TF_VAR_carrental_frontend_domain: ''
        TF_VAR_carrental_api_domain: ''
        TF_VAR_subnet_id: ''
        TF_VAR_route53_zone_id: ''
        TF_VAR_alb_dns_name: ''
        TF_VAR_alb_zone_id: ''
      run: |
        echo "üìã Creating Terraform plan for ${{ env.ENVIRONMENT }} environment..."
        
        # Debug: Show some environment variables are set
        echo "üîç DEBUG: Checking key variables..."
        echo "Environment: ${TF_VAR_environment:-NOT_SET}"
        echo "Project: ${TF_VAR_project_name:-NOT_SET}"
        echo "Region: ${TF_VAR_region:-NOT_SET}"
        echo "Instance Type: ${TF_VAR_instance_type:-NOT_SET}"
        
        # Debug: Verify problematic tag variables are not set
        echo "üîç DEBUG: Verifying tag variables are not set..."
        if [ -n "${TF_VAR_tags:-}" ]; then
          echo "‚ùå ERROR: TF_VAR_tags is set: ${TF_VAR_tags}"
        else
          echo "‚úÖ TF_VAR_tags is not set (good)"
        fi
        
        if [ -n "${TF_VAR_common_tags:-}" ]; then
          echo "‚ùå ERROR: TF_VAR_common_tags is set: ${TF_VAR_common_tags}"
        else
          echo "‚úÖ TF_VAR_common_tags is not set (good)"
        fi

                 # Create plan with detailed exit codes and disable input prompts
         echo "üöÄ Starting terraform plan with timeout protection and auto-retry..."
         
         # Function to run terraform plan with retry on lock conflicts
         run_terraform_plan() {
           local attempt=1
           local max_attempts=3
           
           while [ $attempt -le $max_attempts ]; do
             echo "üìã Attempt $attempt/$max_attempts: Running terraform plan..."
             
             set +e
             timeout 300 terraform plan -input=false -detailed-exitcode -no-color -out=tfplan 2>&1 | tee plan_output.txt
             exit_code=$?
             set -e
            
            # Check if timeout occurred
            if [ $exit_code -eq 124 ]; then
              echo "‚ùå Terraform plan timed out after 5 minutes"
              exit 1
            fi
            
            # Check for lock conflicts
            if grep -q "Error acquiring the state lock" plan_output.txt; then
              echo "üîí Lock conflict detected on attempt $attempt"
              
              if [ $attempt -lt $max_attempts ]; then
                # Extract lock ID and force unlock
                lock_id=$(grep -A 20 "Lock Info:" plan_output.txt | grep "ID:" | awk '{print $2}' || echo "")
                if [ -n "$lock_id" ]; then
                  echo "üîì Force unlocking stale lock: $lock_id"
                  terraform force-unlock -force "$lock_id" || true
                fi
                
                echo "‚è≥ Waiting 30 seconds before retry..."
                sleep 30
                attempt=$((attempt + 1))
                continue
              else
                echo "‚ùå Failed to acquire lock after $max_attempts attempts"
                exit 1
              fi
            else
              # Plan succeeded or failed for other reasons
              break
            fi
          done
          
          return $exit_code
        }
        
        # Run terraform plan with retry logic
        run_terraform_plan
        
        echo "üîç DEBUG: Terraform plan exit code was: $exit_code"
        
        # Check for changes in plan output as backup detection method
        if grep -q "Plan: .* to add\|Plan: .* to change\|Plan: .* to destroy" plan_output.txt; then
          plan_has_changes=$(grep "Plan: " plan_output.txt | grep -v "Plan: 0 to add, 0 to change, 0 to destroy" | wc -l)
        else
          plan_has_changes=0
        fi
        
        echo "üîç DEBUG: Plan changes detected in output: $plan_has_changes"
        
        # Check if there were validation errors (terraform exits with 1 for errors)
        if grep -q "Error:" plan_output.txt; then
          echo "‚ùå Terraform validation errors detected"
          echo "status=error" >> $GITHUB_OUTPUT
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "üîç Showing validation errors:"
          cat plan_output.txt
          exit 1
        fi
        
        case $exit_code in
          0)
            # Double-check for changes even with exit code 0 (terraform bug workaround)
            if [ "$plan_has_changes" -gt 0 ]; then
              echo "‚ö†Ô∏è Exit code 0 but changes detected in plan output - treating as changes"
              echo "status=changes-detected" >> $GITHUB_OUTPUT
              echo "has-changes=true" >> $GITHUB_OUTPUT
              echo "üìù Changes detected (exit code: $exit_code, but plan shows changes)"
            else
              echo "status=no-changes" >> $GITHUB_OUTPUT
              echo "has-changes=false" >> $GITHUB_OUTPUT
              echo "‚úÖ No changes detected (exit code: $exit_code)"
            fi
            ;;
          1)
            echo "status=error" >> $GITHUB_OUTPUT
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "‚ùå Planning failed (exit code: $exit_code)"
            exit 1
            ;;
          2)
            echo "status=changes-detected" >> $GITHUB_OUTPUT
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "üìù Changes detected (exit code: $exit_code)"
            ;;
          *)
            echo "‚ö†Ô∏è Unexpected exit code: $exit_code - treating as error"
            echo "status=error" >> $GITHUB_OUTPUT
            echo "has-changes=false" >> $GITHUB_OUTPUT
            exit 1
            ;;
        esac
        
        # Clean up temporary file
        rm -f plan_output.txt

    - name: Show Plan Summary
      if: steps.plan.outputs.has-changes == 'true'
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üìä Infrastructure Plan Summary for ${{ env.ENVIRONMENT }}:"
        terraform show -no-color tfplan | head -50
        echo ""
        echo "üìà Resource Changes:"
        terraform show -json tfplan | jq -r '.resource_changes[] | "\(.change.action | join(",")): \(.address)"' | sort | uniq -c

    - name: Upload Plan
      if: steps.plan.outputs.has-changes == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan-${{ env.ENVIRONMENT }}
        path: |
          ${{ env.TF_WORKING_DIR }}/tfplan
          ${{ env.TF_WORKING_DIR }}/terraform-${{ env.ENVIRONMENT }}.tfvars

  apply:
    name: 'üöÄ Deploy Infrastructure'
    runs-on: ubuntu-latest
    needs: [format, validate, plan]
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.plan.outputs.has-changes == 'true') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan' && needs.plan.outputs.has-changes == 'true')
    
    steps:
    - name: Auto-Deploy Notification
      run: |
        echo "üöÄ AUTO-DEPLOYMENT TRIGGERED!"
        echo "=============================="
        if [ "${{ github.event.inputs.action }}" = "plan" ]; then
          echo "üéØ Reason: Plan detected changes - proceeding to automatic deployment"
        elif [ "${{ github.event_name }}" = "push" ]; then
          echo "üéØ Reason: Push to main branch with infrastructure changes"
        else
          echo "üéØ Reason: Manual apply action requested"
        fi
        echo "üîß Environment: ${{ env.ENVIRONMENT }}"
        echo "üì¶ Project: ${{ env.PROJECT_NAME }}"
        echo ""

    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Download Plan
      if: needs.plan.outputs.has-changes == 'true'
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan-${{ env.ENVIRONMENT }}
        path: ${{ env.TF_WORKING_DIR }}/

    - name: Terraform Init
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîß Initializing Terraform..."
        terraform init -reconfigure \
          -backend-config="bucket=${{ env.STATE_BUCKET }}" \
          -backend-config="key=${{ env.STATE_KEY }}" \
          -backend-config="region=${{ env.AWS_REGION }}" \
          -backend-config="dynamodb_table=${{ env.LOCK_TABLE }}" \
          -backend-config="encrypt=true"

    - name: Set Environment Variables for Apply
      working-directory: ${{ env.TF_WORKING_DIR }}
      env:
        # Basic Configuration
        TF_VAR_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_environment: ${{ env.ENVIRONMENT }}
        TF_VAR_project_name: ${{ vars.PROJECT_NAME || 'sms-seller-connect' }}
        TF_VAR_ami_id: ${{ vars.AMI_ID || 'ami-0c02fb55956c7d316' }}
        TF_VAR_instance_type: ${{ vars.INSTANCE_TYPE || 't2.micro' }}
        TF_VAR_key_name: ${{ vars.KEY_NAME || 'sms-seller-connect-key' }}
        TF_VAR_instance_name: ${{ vars.INSTANCE_NAME || 'sms-seller-connect' }}
        TF_VAR_vpc_name: ${{ vars.VPC_NAME || 'Grey-VPC' }}
        TF_VAR_subnet_name: ${{ vars.SUBNET_NAME || 'Grey-private-subnet' }}
        TF_VAR_subnet_name_b: ${{ vars.SUBNET_NAME_B || 'Grey-public-subnet' }}
        TF_VAR_admin_ssh_cidr: ${{ vars.ADMIN_SSH_CIDR || '0.0.0.0/0' }}
        TF_VAR_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_bucket_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_ecr_repo_url: ${{ vars.ECR_REPO_URL || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend' }}
        TF_VAR_container_tag: ${{ vars.CONTAINER_TAG || 'latest' }}
        TF_VAR_app_port: ${{ vars.APP_PORT || '8900' }}
        TF_VAR_backend_image: ${{ vars.BACKEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend:latest' }}
        TF_VAR_frontend_image: ${{ vars.FRONTEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-frontend:latest' }}
        TF_VAR_domain_zone_name: ${{ vars.DOMAIN_ZONE_NAME || 'typerelations.com' }}
        TF_VAR_domain_name: ${{ vars.DOMAIN_NAME || 'typerelations.com' }}
        TF_VAR_sms_frontend_domain: ${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_sms_api_domain: ${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_alert_email: ${{ vars.ALERT_EMAIL || 'dcaulcrick01@gmail.com' }}
        TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        TF_VAR_db_host: ${{ secrets.DB_HOST }}
        TF_VAR_db_user: ${{ secrets.DB_USER }}
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_flask_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_jwt_secret_key: ${{ secrets.JWT_SECRET_KEY }}
        TF_VAR_twilio_account_sid: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TF_VAR_twilio_auth_token: ${{ secrets.TWILIO_AUTH_TOKEN }}
        TF_VAR_twilio_phone_number: ${{ secrets.TWILIO_PHONE_NUMBER }}
        TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        TF_VAR_sendgrid_api_key: ${{ secrets.SENDGRID_API_KEY }}
        TF_VAR_ngrok_auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}
        TF_VAR_hot_lead_sms_recipients: ${{ secrets.HOT_LEAD_SMS_RECIPIENTS }}
        TF_VAR_database_url: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:5437/sms_blast
        TF_VAR_twilio_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/webhooks/sms
        TF_VAR_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_frontend_url: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_db_port: ${{ vars.DB_PORT || '5437' }}
        TF_VAR_db_name: ${{ vars.DB_NAME || 'sms_blast' }}
        TF_VAR_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_openai_model: ${{ vars.OPENAI_MODEL || 'gpt-3.5-turbo' }}
        TF_VAR_openai_temperature: ${{ vars.OPENAI_TEMPERATURE || '0.7' }}
        TF_VAR_sendgrid_from_email: ${{ vars.SENDGRID_FROM_EMAIL || 'noreply@typerelations.com' }}
        TF_VAR_aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_aws_default_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_backend_port: ${{ vars.BACKEND_PORT || '8900' }}
        TF_VAR_frontend_port: ${{ vars.FRONTEND_PORT || '3000' }}
        TF_VAR_vite_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_backend_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_allowed_origins: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_ngrok_port: ${{ vars.NGROK_PORT || '4040' }}
        TF_VAR_ngrok_url: ${{ vars.NGROK_URL || '' }}
        TF_VAR_ngrok_subdomain: ${{ vars.NGROK_SUBDOMAIN || '' }}
        TF_VAR_log_level: ${{ vars.LOG_LEVEL || 'INFO' }}
        TF_VAR_hot_lead_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/alerts
        TF_VAR_hot_lead_email_recipients: ${{ vars.HOT_LEAD_EMAIL_RECIPIENTS || 'dcaulcrick01@gmail.com' }}
        TF_VAR_rate_limit_per_minute: ${{ vars.RATE_LIMIT_PER_MINUTE || '100' }}
        TF_VAR_rate_limit_burst: ${{ vars.RATE_LIMIT_BURST || '200' }}
        TF_VAR_session_timeout_minutes: ${{ vars.SESSION_TIMEOUT_MINUTES || '60' }}
        TF_VAR_remember_me_days: ${{ vars.REMEMBER_ME_DAYS || '30' }}
        TF_VAR_max_file_size_mb: ${{ vars.MAX_FILE_SIZE_MB || '10' }}
        TF_VAR_allowed_file_types: ${{ vars.ALLOWED_FILE_TYPES || 'csv,xlsx,txt' }}
        TF_VAR_carrental_frontend_domain: ''
        TF_VAR_carrental_api_domain: ''
        TF_VAR_subnet_id: ''
        TF_VAR_route53_zone_id: ''
        TF_VAR_alb_dns_name: ''
        TF_VAR_alb_zone_id: ''
      run: |
        echo "üîß Setting up environment variables for apply..."
        echo "‚úÖ All Terraform environment variables configured using GitHub Actions env context"

    - name: Set Boolean Environment Variables for Apply
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîß Setting boolean environment variables for Terraform Apply..."
        
        # Set use_default_vpc
        if [ "${{ vars.USE_DEFAULT_VPC || 'true' }}" = "true" ]; then
          echo "TF_VAR_use_default_vpc=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_use_default_vpc=false" >> $GITHUB_ENV
        fi
        
        # Set s3_force_destroy
        if [ "${{ vars.S3_FORCE_DESTROY || 'false' }}" = "true" ]; then
          echo "TF_VAR_s3_force_destroy=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_s3_force_destroy=false" >> $GITHUB_ENV
        fi
        
        # Set use_postgres
        if [ "${{ vars.USE_POSTGRES || 'true' }}" = "true" ]; then
          echo "TF_VAR_use_postgres=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_use_postgres=false" >> $GITHUB_ENV
        fi
        
        # Set start_ngrok
        if [ "${{ vars.START_NGROK || 'true' }}" = "true" ]; then
          echo "TF_VAR_start_ngrok=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_start_ngrok=false" >> $GITHUB_ENV
        fi
        
        # Set debug
        if [ "${{ vars.DEBUG || 'true' }}" = "true" ]; then
          echo "TF_VAR_debug=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_debug=false" >> $GITHUB_ENV
        fi
        
        # Set enable_carrental_domain (hardcoded to false)
        echo "TF_VAR_enable_carrental_domain=false" >> $GITHUB_ENV
        
        echo "‚úÖ Boolean environment variables set for Apply!"

    - name: Terraform Apply
      working-directory: ${{ env.TF_WORKING_DIR }}
      env:
        # Basic Configuration
        TF_VAR_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_environment: ${{ env.ENVIRONMENT }}
        TF_VAR_project_name: ${{ vars.PROJECT_NAME || 'sms-seller-connect' }}
        TF_VAR_ami_id: ${{ vars.AMI_ID || 'ami-0c02fb55956c7d316' }}
        TF_VAR_instance_type: ${{ vars.INSTANCE_TYPE || 't2.micro' }}
        TF_VAR_key_name: ${{ vars.KEY_NAME || 'sms-seller-connect-key' }}
        TF_VAR_instance_name: ${{ vars.INSTANCE_NAME || 'sms-seller-connect' }}
        TF_VAR_vpc_name: ${{ vars.VPC_NAME || 'Grey-VPC' }}
        TF_VAR_subnet_name: ${{ vars.SUBNET_NAME || 'Grey-private-subnet' }}
        TF_VAR_subnet_name_b: ${{ vars.SUBNET_NAME_B || 'Grey-public-subnet' }}
        TF_VAR_admin_ssh_cidr: ${{ vars.ADMIN_SSH_CIDR || '0.0.0.0/0' }}
        TF_VAR_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_bucket_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_ecr_repo_url: ${{ vars.ECR_REPO_URL || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend' }}
        TF_VAR_container_tag: ${{ vars.CONTAINER_TAG || 'latest' }}
        TF_VAR_app_port: ${{ vars.APP_PORT || '8900' }}
        TF_VAR_backend_image: ${{ vars.BACKEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend:latest' }}
        TF_VAR_frontend_image: ${{ vars.FRONTEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-frontend:latest' }}
        TF_VAR_domain_zone_name: ${{ vars.DOMAIN_ZONE_NAME || 'typerelations.com' }}
        TF_VAR_domain_name: ${{ vars.DOMAIN_NAME || 'typerelations.com' }}
        TF_VAR_sms_frontend_domain: ${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_sms_api_domain: ${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_alert_email: ${{ vars.ALERT_EMAIL || 'dcaulcrick01@gmail.com' }}
        TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        TF_VAR_db_host: ${{ secrets.DB_HOST }}
        TF_VAR_db_user: ${{ secrets.DB_USER }}
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_flask_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_jwt_secret_key: ${{ secrets.JWT_SECRET_KEY }}
        TF_VAR_twilio_account_sid: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TF_VAR_twilio_auth_token: ${{ secrets.TWILIO_AUTH_TOKEN }}
        TF_VAR_twilio_phone_number: ${{ secrets.TWILIO_PHONE_NUMBER }}
        TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        TF_VAR_sendgrid_api_key: ${{ secrets.SENDGRID_API_KEY }}
        TF_VAR_ngrok_auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}
        TF_VAR_hot_lead_sms_recipients: ${{ secrets.HOT_LEAD_SMS_RECIPIENTS }}
        TF_VAR_database_url: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:5437/sms_blast
        TF_VAR_twilio_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/webhooks/sms
        TF_VAR_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_frontend_url: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_db_port: ${{ vars.DB_PORT || '5437' }}
        TF_VAR_db_name: ${{ vars.DB_NAME || 'sms_blast' }}
        TF_VAR_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_openai_model: ${{ vars.OPENAI_MODEL || 'gpt-3.5-turbo' }}
        TF_VAR_openai_temperature: ${{ vars.OPENAI_TEMPERATURE || '0.7' }}
        TF_VAR_sendgrid_from_email: ${{ vars.SENDGRID_FROM_EMAIL || 'noreply@typerelations.com' }}
        TF_VAR_aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_aws_default_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_backend_port: ${{ vars.BACKEND_PORT || '8900' }}
        TF_VAR_frontend_port: ${{ vars.FRONTEND_PORT || '3000' }}
        TF_VAR_vite_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_backend_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_allowed_origins: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_ngrok_port: ${{ vars.NGROK_PORT || '4040' }}
        TF_VAR_ngrok_url: ${{ vars.NGROK_URL || '' }}
        TF_VAR_ngrok_subdomain: ${{ vars.NGROK_SUBDOMAIN || '' }}
        TF_VAR_log_level: ${{ vars.LOG_LEVEL || 'INFO' }}
        TF_VAR_hot_lead_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/alerts
        TF_VAR_hot_lead_email_recipients: ${{ vars.HOT_LEAD_EMAIL_RECIPIENTS || 'dcaulcrick01@gmail.com' }}
        TF_VAR_rate_limit_per_minute: ${{ vars.RATE_LIMIT_PER_MINUTE || '100' }}
        TF_VAR_rate_limit_burst: ${{ vars.RATE_LIMIT_BURST || '200' }}
        TF_VAR_session_timeout_minutes: ${{ vars.SESSION_TIMEOUT_MINUTES || '60' }}
        TF_VAR_remember_me_days: ${{ vars.REMEMBER_ME_DAYS || '30' }}
        TF_VAR_max_file_size_mb: ${{ vars.MAX_FILE_SIZE_MB || '10' }}
        TF_VAR_allowed_file_types: ${{ vars.ALLOWED_FILE_TYPES || 'csv,xlsx,txt' }}
        TF_VAR_carrental_frontend_domain: ''
        TF_VAR_carrental_api_domain: ''
        TF_VAR_subnet_id: ''
        TF_VAR_route53_zone_id: ''
        TF_VAR_alb_dns_name: ''
        TF_VAR_alb_zone_id: ''
      run: |
        echo "üöÄ Applying Terraform changes for ${{ env.ENVIRONMENT }} environment..."
        echo "üìç Backend: s3://${{ env.STATE_BUCKET }}/${{ env.STATE_KEY }}"
        
                 if [ -f "tfplan" ]; then
           echo "üìã Applying saved plan..."
           terraform apply -auto-approve tfplan
         else
           echo "üìã Creating and applying new plan..."
           terraform apply -auto-approve
         fi
        
        echo "‚úÖ SMS Seller Connect infrastructure deployment completed!"

    - name: Get Infrastructure Outputs
      id: outputs
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üìä Getting infrastructure outputs..."
        
        # Get EC2 outputs
        if terraform output instance_public_ip > /dev/null 2>&1; then
          INSTANCE_IP=$(terraform output -raw instance_public_ip 2>/dev/null || echo "N/A")
          echo "instance_ip=${INSTANCE_IP}" >> $GITHUB_OUTPUT
          echo "üåê Instance IP: ${INSTANCE_IP}"
        fi
        
        if terraform output instance_id > /dev/null 2>&1; then
          INSTANCE_ID=$(terraform output -raw instance_id 2>/dev/null || echo "N/A")
          echo "instance_id=${INSTANCE_ID}" >> $GITHUB_OUTPUT
          echo "üÜî Instance ID: ${INSTANCE_ID}"
        fi
        
        # Get ALB outputs
        if terraform output alb_dns_name > /dev/null 2>&1; then
          ALB_DNS=$(terraform output -raw alb_dns_name 2>/dev/null || echo "N/A")
          echo "alb_dns=${ALB_DNS}" >> $GITHUB_OUTPUT
          echo "üîó ALB DNS: ${ALB_DNS}"
        fi
        
        # Get S3 outputs
        if terraform output s3_bucket_name > /dev/null 2>&1; then
          BUCKET_NAME=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "N/A")
          echo "bucket_name=${BUCKET_NAME}" >> $GITHUB_OUTPUT
          echo "ü™£ Bucket Name: ${BUCKET_NAME}"
        fi
        
        # Get domain outputs
        if terraform output sms_frontend_url > /dev/null 2>&1; then
          FRONTEND_URL=$(terraform output -raw sms_frontend_url 2>/dev/null || echo "N/A")
          echo "frontend_url=${FRONTEND_URL}" >> $GITHUB_OUTPUT
          echo "üåê Frontend URL: ${FRONTEND_URL}"
        fi
        
        if terraform output sms_api_url > /dev/null 2>&1; then
          API_URL=$(terraform output -raw sms_api_url 2>/dev/null || echo "N/A")
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "üîó API URL: ${API_URL}"
        fi
        
        # Show all outputs
        echo "üìã All outputs:"
        terraform output 2>/dev/null || echo "‚ÑπÔ∏è No outputs available"

    - name: Verify ALB Health
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîç Verifying ALB deployment..."
        
        ALB_DNS="${{ steps.outputs.outputs.alb_dns }}"
        if [ "$ALB_DNS" != "N/A" ] && [ -n "$ALB_DNS" ]; then
          echo "üåê Testing ALB health endpoint..."
          
          # Wait for ALB to be ready
          echo "‚è≥ Waiting for ALB to be ready..."
          sleep 120
          
          # Test ALB health endpoint
          if curl -f -m 30 "http://${ALB_DNS}/alb-health" > /dev/null 2>&1; then
            echo "‚úÖ ALB health check responding"
          else
            echo "‚ö†Ô∏è ALB health check not yet responding (may still be starting)"
          fi
        else
          echo "‚ö†Ô∏è No ALB DNS available for verification"
        fi

    - name: Verify Application Health
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîç Verifying SMS Seller Connect application..."
        
        API_URL="${{ steps.outputs.outputs.api_url }}"
        if [ "$API_URL" != "N/A" ] && [ -n "$API_URL" ]; then
          echo "üåê Testing application health..."
          
          # Wait for application to be ready
          echo "‚è≥ Waiting for application to be ready..."
          sleep 180
          
          # Test API health endpoint
          if curl -f -m 30 "${API_URL}/api/health" > /dev/null 2>&1; then
            echo "‚úÖ SMS Seller Connect API is responding"
          else
            echo "‚ö†Ô∏è Application not yet responding (may still be starting)"
          fi
          
          # Test database connection
          if curl -f -m 30 "${API_URL}/api/test-db" > /dev/null 2>&1; then
            echo "‚úÖ Database connection verified"
          else
            echo "‚ö†Ô∏è Database connection test failed"
          fi
        else
          echo "‚ö†Ô∏è No API URL available for verification"
        fi

    - name: Verify S3 Deployment
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîç Verifying S3 deployment..."
        
        BUCKET_NAME="${{ steps.outputs.outputs.bucket_name }}"
        if [ "$BUCKET_NAME" != "N/A" ] && [ -n "$BUCKET_NAME" ]; then
          echo "ü™£ Testing S3 bucket accessibility..."
          if aws s3 ls "s3://${BUCKET_NAME}" > /dev/null 2>&1; then
            echo "‚úÖ S3 bucket is accessible"
            
            # Check for required files
            echo "üìÅ Checking for required configuration files..."
            aws s3 ls "s3://${BUCKET_NAME}/docker-compose/" || echo "‚ö†Ô∏è Docker compose files not found"
            aws s3 ls "s3://${BUCKET_NAME}/nginx/" || echo "‚ö†Ô∏è Nginx config not found"
            aws s3 ls "s3://${BUCKET_NAME}/scripts/" || echo "‚ö†Ô∏è Scripts not found"
          else
            echo "‚ö†Ô∏è S3 bucket not yet accessible"
          fi
        else
          echo "‚ö†Ô∏è No bucket name available for verification"
        fi

    - name: Update CloudWatch Dashboard
      run: |
        echo "üìä Updating CloudWatch dashboard..."
        
        # Create/update CloudWatch dashboard for monitoring
        aws cloudwatch put-dashboard \
          --dashboard-name "SMS-Seller-Connect-${{ env.ENVIRONMENT }}" \
          --dashboard-body '{
            "widgets": [
              {
                "type": "metric",
                "properties": {
                  "metrics": [
                    ["AWS/EC2", "CPUUtilization", "InstanceId", "${{ steps.outputs.outputs.instance_id }}"],
                    [".", "NetworkIn", ".", "."],
                    [".", "NetworkOut", ".", "."]
                  ],
                  "period": 300,
                  "stat": "Average",
                  "region": "${{ env.AWS_REGION }}",
                  "title": "EC2 System Metrics"
                }
              },
              {
                "type": "metric",
                "properties": {
                  "metrics": [
                    ["AWS/ApplicationELB", "RequestCount", "LoadBalancer", "${{ steps.outputs.outputs.alb_dns }}"],
                    [".", "TargetResponseTime", ".", "."],
                    [".", "HTTPCode_Target_2XX_Count", ".", "."]
                  ],
                  "period": 300,
                  "stat": "Sum",
                  "region": "${{ env.AWS_REGION }}",
                  "title": "ALB Metrics"
                }
              }
            ]
          }' || echo "‚ö†Ô∏è Dashboard update failed, continuing..."

    - name: Display Deployment Results
      if: always()
      run: |
        echo "#### üöÄ SMS Seller Connect Deployment Results"
        echo ""
        echo "**Status**: ${{ job.status == 'success' && '‚úÖ Successfully Deployed' || '‚ùå Deployment Failed' }}"
        echo "**Environment**: ${{ env.ENVIRONMENT }}"
        echo "**Project**: ${{ env.PROJECT_NAME }}"
        echo ""
        echo "### üåê Application URLs:"
        echo "- **Frontend**: ${{ steps.outputs.outputs.frontend_url }}"
        echo "- **API**: ${{ steps.outputs.outputs.api_url }}"
        echo "- **Health Check**: ${{ steps.outputs.outputs.api_url }}/api/health"
        echo ""
        echo "### üèóÔ∏è Infrastructure Details:"
        echo "- **Instance IP**: ${{ steps.outputs.outputs.instance_ip }}"
        echo "- **Instance ID**: ${{ steps.outputs.outputs.instance_id }}"
        echo "- **ALB DNS**: ${{ steps.outputs.outputs.alb_dns }}"
        echo "- **S3 Bucket**: ${{ steps.outputs.outputs.bucket_name }}"
        echo "- **ECR Repository**: ${{ env.ECR_REPOSITORY }}"
        echo ""
        echo "### üìä Monitoring Links:"
        echo "- **CloudWatch**: https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#dashboards:name=SMS-Seller-Connect-${{ env.ENVIRONMENT }}"
        echo "- **EC2 Console**: https://console.aws.amazon.com/ec2/home?region=${{ env.AWS_REGION }}#Instances:search=${{ steps.outputs.outputs.instance_id }}"
        echo "- **ALB Console**: https://console.aws.amazon.com/ec2/home?region=${{ env.AWS_REGION }}#LoadBalancers:"
        echo ""
        echo "### üîß Features Deployed:"
        echo "- ‚úÖ EC2 Instance with ALB multi-app architecture"
        echo "- ‚úÖ Application Load Balancer with SSL termination"
        echo "- ‚úÖ S3 bucket for configuration files"
        echo "- ‚úÖ CloudWatch monitoring and logging"
        echo "- ‚úÖ Route53 DNS records"
        echo "- ‚úÖ ACM SSL certificates"
        echo "- ‚úÖ Docker containerized applications"
        echo "- ‚úÖ Nginx reverse proxy"

    - name: Display Route53 Name Servers
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üåê Route53 Name Servers for Domain Configuration"
        echo "================================================"
        
        # Get the name servers from Terraform output
        if terraform output route53_name_servers > /dev/null 2>&1; then
          NAME_SERVERS=$(terraform output -raw route53_name_servers 2>/dev/null || echo "N/A")
          ZONE_ID=$(terraform output -raw route53_zone_id 2>/dev/null || echo "N/A")
          ZONE_NAME=$(terraform output -raw route53_zone_name 2>/dev/null || echo "N/A")
          
          echo "üìã **IMPORTANT**: Update your domain registrar with these name servers:"
          echo "üÜî Zone ID: $ZONE_ID"
          echo "üåê Zone Name: $ZONE_NAME"
          echo ""
          echo "üìù Name Servers to configure with your registrar:"
          echo "$NAME_SERVERS" | sed 's/\[//g' | sed 's/\]//g' | sed 's/,/\n/g' | sed 's/"//g' | sed 's/^ *//g'
          echo ""
          echo "‚ö†Ô∏è  **Domain will not resolve until name servers are updated with your registrar!**"
        else
          echo "‚ö†Ô∏è Could not retrieve Route53 name servers from Terraform output"
        fi

  destroy:
    name: 'üí• Destroy Infrastructure'
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîß Initializing Terraform..."
        terraform init -reconfigure \
          -backend-config="bucket=${{ env.STATE_BUCKET }}" \
          -backend-config="key=${{ env.STATE_KEY }}" \
          -backend-config="region=${{ env.AWS_REGION }}" \
          -backend-config="dynamodb_table=${{ env.LOCK_TABLE }}" \
          -backend-config="encrypt=true"

    - name: Set Environment Variables for Destroy
      working-directory: ${{ env.TF_WORKING_DIR }}
      env:
        # Basic Configuration
        TF_VAR_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_environment: ${{ env.ENVIRONMENT }}
        TF_VAR_project_name: ${{ vars.PROJECT_NAME || 'sms-seller-connect' }}
        TF_VAR_ami_id: ${{ vars.AMI_ID || 'ami-0c02fb55956c7d316' }}
        TF_VAR_instance_type: ${{ vars.INSTANCE_TYPE || 't2.micro' }}
        TF_VAR_key_name: ${{ vars.KEY_NAME || 'sms-seller-connect-key' }}
        TF_VAR_instance_name: ${{ vars.INSTANCE_NAME || 'sms-seller-connect' }}
        TF_VAR_vpc_name: ${{ vars.VPC_NAME || 'Grey-VPC' }}
        TF_VAR_subnet_name: ${{ vars.SUBNET_NAME || 'Grey-private-subnet' }}
        TF_VAR_subnet_name_b: ${{ vars.SUBNET_NAME_B || 'Grey-public-subnet' }}
        TF_VAR_admin_ssh_cidr: ${{ vars.ADMIN_SSH_CIDR || '0.0.0.0/0' }}
        TF_VAR_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_bucket_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_ecr_repo_url: ${{ vars.ECR_REPO_URL || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend' }}
        TF_VAR_container_tag: ${{ vars.CONTAINER_TAG || 'latest' }}
        TF_VAR_app_port: ${{ vars.APP_PORT || '8900' }}
        TF_VAR_backend_image: ${{ vars.BACKEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend:latest' }}
        TF_VAR_frontend_image: ${{ vars.FRONTEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-frontend:latest' }}
        TF_VAR_domain_zone_name: ${{ vars.DOMAIN_ZONE_NAME || 'typerelations.com' }}
        TF_VAR_domain_name: ${{ vars.DOMAIN_NAME || 'typerelations.com' }}
        TF_VAR_sms_frontend_domain: ${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_sms_api_domain: ${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_alert_email: ${{ vars.ALERT_EMAIL || 'dcaulcrick01@gmail.com' }}
        TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        TF_VAR_db_host: ${{ secrets.DB_HOST }}
        TF_VAR_db_user: ${{ secrets.DB_USER }}
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_flask_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_jwt_secret_key: ${{ secrets.JWT_SECRET_KEY }}
        TF_VAR_twilio_account_sid: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TF_VAR_twilio_auth_token: ${{ secrets.TWILIO_AUTH_TOKEN }}
        TF_VAR_twilio_phone_number: ${{ secrets.TWILIO_PHONE_NUMBER }}
        TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        TF_VAR_sendgrid_api_key: ${{ secrets.SENDGRID_API_KEY }}
        TF_VAR_ngrok_auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}
        TF_VAR_hot_lead_sms_recipients: ${{ secrets.HOT_LEAD_SMS_RECIPIENTS }}
        TF_VAR_database_url: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:5437/sms_blast
        TF_VAR_twilio_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/webhooks/sms
        TF_VAR_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_frontend_url: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_db_port: ${{ vars.DB_PORT || '5437' }}
        TF_VAR_db_name: ${{ vars.DB_NAME || 'sms_blast' }}
        TF_VAR_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_openai_model: ${{ vars.OPENAI_MODEL || 'gpt-3.5-turbo' }}
        TF_VAR_openai_temperature: ${{ vars.OPENAI_TEMPERATURE || '0.7' }}
        TF_VAR_sendgrid_from_email: ${{ vars.SENDGRID_FROM_EMAIL || 'noreply@typerelations.com' }}
        TF_VAR_aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_aws_default_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_backend_port: ${{ vars.BACKEND_PORT || '8900' }}
        TF_VAR_frontend_port: ${{ vars.FRONTEND_PORT || '3000' }}
        TF_VAR_vite_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_backend_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_allowed_origins: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_ngrok_port: ${{ vars.NGROK_PORT || '4040' }}
        TF_VAR_ngrok_url: ${{ vars.NGROK_URL || '' }}
        TF_VAR_ngrok_subdomain: ${{ vars.NGROK_SUBDOMAIN || '' }}
        TF_VAR_log_level: ${{ vars.LOG_LEVEL || 'INFO' }}
        TF_VAR_hot_lead_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/alerts
        TF_VAR_hot_lead_email_recipients: ${{ vars.HOT_LEAD_EMAIL_RECIPIENTS || 'dcaulcrick01@gmail.com' }}
        TF_VAR_rate_limit_per_minute: ${{ vars.RATE_LIMIT_PER_MINUTE || '100' }}
        TF_VAR_rate_limit_burst: ${{ vars.RATE_LIMIT_BURST || '200' }}
        TF_VAR_session_timeout_minutes: ${{ vars.SESSION_TIMEOUT_MINUTES || '60' }}
        TF_VAR_remember_me_days: ${{ vars.REMEMBER_ME_DAYS || '30' }}
        TF_VAR_max_file_size_mb: ${{ vars.MAX_FILE_SIZE_MB || '10' }}
        TF_VAR_allowed_file_types: ${{ vars.ALLOWED_FILE_TYPES || 'csv,xlsx,txt' }}
        TF_VAR_carrental_frontend_domain: ''
        TF_VAR_carrental_api_domain: ''
        TF_VAR_subnet_id: ''
        TF_VAR_route53_zone_id: ''
        TF_VAR_alb_dns_name: ''
        TF_VAR_alb_zone_id: ''
      run: |
        echo "üîß Setting up environment variables for destroy..."
        echo "‚úÖ All Terraform environment variables configured using GitHub Actions env context"

    - name: Set Boolean Environment Variables for Destroy
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üîß Setting boolean environment variables for Terraform Destroy..."
        
        # Set use_default_vpc
        if [ "${{ vars.USE_DEFAULT_VPC || 'true' }}" = "true" ]; then
          echo "TF_VAR_use_default_vpc=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_use_default_vpc=false" >> $GITHUB_ENV
        fi
        
        # Set s3_force_destroy
        if [ "${{ vars.S3_FORCE_DESTROY || 'false' }}" = "true" ]; then
          echo "TF_VAR_s3_force_destroy=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_s3_force_destroy=false" >> $GITHUB_ENV
        fi
        
        # Set use_postgres
        if [ "${{ vars.USE_POSTGRES || 'true' }}" = "true" ]; then
          echo "TF_VAR_use_postgres=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_use_postgres=false" >> $GITHUB_ENV
        fi
        
        # Set start_ngrok
        if [ "${{ vars.START_NGROK || 'true' }}" = "true" ]; then
          echo "TF_VAR_start_ngrok=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_start_ngrok=false" >> $GITHUB_ENV
        fi
        
        # Set debug
        if [ "${{ vars.DEBUG || 'true' }}" = "true" ]; then
          echo "TF_VAR_debug=true" >> $GITHUB_ENV
        else
          echo "TF_VAR_debug=false" >> $GITHUB_ENV
        fi
        
        # Set enable_carrental_domain (hardcoded to false)
        echo "TF_VAR_enable_carrental_domain=false" >> $GITHUB_ENV
        
        echo "‚úÖ Boolean environment variables set for Destroy!"

    - name: Show Resources to be Destroyed
      working-directory: ${{ env.TF_WORKING_DIR }}
      env:
        # Basic Configuration
        TF_VAR_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_environment: ${{ env.ENVIRONMENT }}
        TF_VAR_project_name: ${{ vars.PROJECT_NAME || 'sms-seller-connect' }}
        TF_VAR_ami_id: ${{ vars.AMI_ID || 'ami-0c02fb55956c7d316' }}
        TF_VAR_instance_type: ${{ vars.INSTANCE_TYPE || 't2.micro' }}
        TF_VAR_key_name: ${{ vars.KEY_NAME || 'sms-seller-connect-key' }}
        TF_VAR_instance_name: ${{ vars.INSTANCE_NAME || 'sms-seller-connect' }}
        TF_VAR_vpc_name: ${{ vars.VPC_NAME || 'Grey-VPC' }}
        TF_VAR_subnet_name: ${{ vars.SUBNET_NAME || 'Grey-private-subnet' }}
        TF_VAR_subnet_name_b: ${{ vars.SUBNET_NAME_B || 'Grey-public-subnet' }}
        TF_VAR_admin_ssh_cidr: ${{ vars.ADMIN_SSH_CIDR || '0.0.0.0/0' }}
        TF_VAR_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_bucket_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_ecr_repo_url: ${{ vars.ECR_REPO_URL || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend' }}
        TF_VAR_container_tag: ${{ vars.CONTAINER_TAG || 'latest' }}
        TF_VAR_app_port: ${{ vars.APP_PORT || '8900' }}
        TF_VAR_backend_image: ${{ vars.BACKEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend:latest' }}
        TF_VAR_frontend_image: ${{ vars.FRONTEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-frontend:latest' }}
        TF_VAR_domain_zone_name: ${{ vars.DOMAIN_ZONE_NAME || 'typerelations.com' }}
        TF_VAR_domain_name: ${{ vars.DOMAIN_NAME || 'typerelations.com' }}
        TF_VAR_sms_frontend_domain: ${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_sms_api_domain: ${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_alert_email: ${{ vars.ALERT_EMAIL || 'dcaulcrick01@gmail.com' }}
        TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        TF_VAR_db_host: ${{ secrets.DB_HOST }}
        TF_VAR_db_user: ${{ secrets.DB_USER }}
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_flask_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_jwt_secret_key: ${{ secrets.JWT_SECRET_KEY }}
        TF_VAR_twilio_account_sid: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TF_VAR_twilio_auth_token: ${{ secrets.TWILIO_AUTH_TOKEN }}
        TF_VAR_twilio_phone_number: ${{ secrets.TWILIO_PHONE_NUMBER }}
        TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        TF_VAR_sendgrid_api_key: ${{ secrets.SENDGRID_API_KEY }}
        TF_VAR_ngrok_auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}
        TF_VAR_hot_lead_sms_recipients: ${{ secrets.HOT_LEAD_SMS_RECIPIENTS }}
        TF_VAR_database_url: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:5437/sms_blast
        TF_VAR_twilio_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/webhooks/sms
        TF_VAR_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_frontend_url: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_db_port: ${{ vars.DB_PORT || '5437' }}
        TF_VAR_db_name: ${{ vars.DB_NAME || 'sms_blast' }}
        TF_VAR_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_openai_model: ${{ vars.OPENAI_MODEL || 'gpt-3.5-turbo' }}
        TF_VAR_openai_temperature: ${{ vars.OPENAI_TEMPERATURE || '0.7' }}
        TF_VAR_sendgrid_from_email: ${{ vars.SENDGRID_FROM_EMAIL || 'noreply@typerelations.com' }}
        TF_VAR_aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_aws_default_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_backend_port: ${{ vars.BACKEND_PORT || '8900' }}
        TF_VAR_frontend_port: ${{ vars.FRONTEND_PORT || '3000' }}
        TF_VAR_vite_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_backend_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_allowed_origins: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_ngrok_port: ${{ vars.NGROK_PORT || '4040' }}
        TF_VAR_ngrok_url: ${{ vars.NGROK_URL || '' }}
        TF_VAR_ngrok_subdomain: ${{ vars.NGROK_SUBDOMAIN || '' }}
        TF_VAR_log_level: ${{ vars.LOG_LEVEL || 'INFO' }}
        TF_VAR_hot_lead_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/alerts
        TF_VAR_hot_lead_email_recipients: ${{ vars.HOT_LEAD_EMAIL_RECIPIENTS || 'dcaulcrick01@gmail.com' }}
        TF_VAR_rate_limit_per_minute: ${{ vars.RATE_LIMIT_PER_MINUTE || '100' }}
        TF_VAR_rate_limit_burst: ${{ vars.RATE_LIMIT_BURST || '200' }}
        TF_VAR_session_timeout_minutes: ${{ vars.SESSION_TIMEOUT_MINUTES || '60' }}
        TF_VAR_remember_me_days: ${{ vars.REMEMBER_ME_DAYS || '30' }}
        TF_VAR_max_file_size_mb: ${{ vars.MAX_FILE_SIZE_MB || '10' }}
        TF_VAR_allowed_file_types: ${{ vars.ALLOWED_FILE_TYPES || 'csv,xlsx,txt' }}
        TF_VAR_carrental_frontend_domain: ''
        TF_VAR_carrental_api_domain: ''
        TF_VAR_subnet_id: ''
        TF_VAR_route53_zone_id: ''
        TF_VAR_alb_dns_name: ''
        TF_VAR_alb_zone_id: ''
      run: |
        echo "üîç Resources that will be destroyed in ${{ env.ENVIRONMENT }}:"
        
        terraform state list
        echo ""
        echo "üìã Destroy plan:"
        terraform plan -destroy -no-color

    - name: Terraform Destroy
      working-directory: ${{ env.TF_WORKING_DIR }}
      env:
        # Basic Configuration
        TF_VAR_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_environment: ${{ env.ENVIRONMENT }}
        TF_VAR_project_name: ${{ vars.PROJECT_NAME || 'sms-seller-connect' }}
        TF_VAR_ami_id: ${{ vars.AMI_ID || 'ami-0c02fb55956c7d316' }}
        TF_VAR_instance_type: ${{ vars.INSTANCE_TYPE || 't2.micro' }}
        TF_VAR_key_name: ${{ vars.KEY_NAME || 'sms-seller-connect-key' }}
        TF_VAR_instance_name: ${{ vars.INSTANCE_NAME || 'sms-seller-connect' }}
        TF_VAR_vpc_name: ${{ vars.VPC_NAME || 'Grey-VPC' }}
        TF_VAR_subnet_name: ${{ vars.SUBNET_NAME || 'Grey-private-subnet' }}
        TF_VAR_subnet_name_b: ${{ vars.SUBNET_NAME_B || 'Grey-public-subnet' }}
        TF_VAR_admin_ssh_cidr: ${{ vars.ADMIN_SSH_CIDR || '0.0.0.0/0' }}
        TF_VAR_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_bucket_name: ${{ vars.S3_BUCKET_NAME || 'sms-seller-connect-bucket' }}
        TF_VAR_s3_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_bucket_acl: ${{ vars.S3_ACL || 'private' }}
        TF_VAR_ecr_repo_url: ${{ vars.ECR_REPO_URL || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend' }}
        TF_VAR_container_tag: ${{ vars.CONTAINER_TAG || 'latest' }}
        TF_VAR_app_port: ${{ vars.APP_PORT || '8900' }}
        TF_VAR_backend_image: ${{ vars.BACKEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend:latest' }}
        TF_VAR_frontend_image: ${{ vars.FRONTEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-frontend:latest' }}
        TF_VAR_domain_zone_name: ${{ vars.DOMAIN_ZONE_NAME || 'typerelations.com' }}
        TF_VAR_domain_name: ${{ vars.DOMAIN_NAME || 'typerelations.com' }}
        TF_VAR_sms_frontend_domain: ${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_sms_api_domain: ${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_alert_email: ${{ vars.ALERT_EMAIL || 'dcaulcrick01@gmail.com' }}
        TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        TF_VAR_db_host: ${{ secrets.DB_HOST }}
        TF_VAR_db_user: ${{ secrets.DB_USER }}
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_flask_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_jwt_secret_key: ${{ secrets.JWT_SECRET_KEY }}
        TF_VAR_twilio_account_sid: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TF_VAR_twilio_auth_token: ${{ secrets.TWILIO_AUTH_TOKEN }}
        TF_VAR_twilio_phone_number: ${{ secrets.TWILIO_PHONE_NUMBER }}
        TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        TF_VAR_sendgrid_api_key: ${{ secrets.SENDGRID_API_KEY }}
        TF_VAR_ngrok_auth_token: ${{ secrets.NGROK_AUTH_TOKEN }}
        TF_VAR_hot_lead_sms_recipients: ${{ secrets.HOT_LEAD_SMS_RECIPIENTS }}
        TF_VAR_database_url: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:5437/sms_blast
        TF_VAR_twilio_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/webhooks/sms
        TF_VAR_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_frontend_url: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_db_port: ${{ vars.DB_PORT || '5437' }}
        TF_VAR_db_name: ${{ vars.DB_NAME || 'sms_blast' }}
        TF_VAR_secret_key: ${{ secrets.FLASK_SECRET_KEY }}
        TF_VAR_openai_model: ${{ vars.OPENAI_MODEL || 'gpt-3.5-turbo' }}
        TF_VAR_openai_temperature: ${{ vars.OPENAI_TEMPERATURE || '0.7' }}
        TF_VAR_sendgrid_from_email: ${{ vars.SENDGRID_FROM_EMAIL || 'noreply@typerelations.com' }}
        TF_VAR_aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_aws_default_region: ${{ vars.AWS_REGION || 'us-east-1' }}
        TF_VAR_backend_port: ${{ vars.BACKEND_PORT || '8900' }}
        TF_VAR_frontend_port: ${{ vars.FRONTEND_PORT || '3000' }}
        TF_VAR_vite_api_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_backend_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}
        TF_VAR_allowed_origins: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}
        TF_VAR_ngrok_port: ${{ vars.NGROK_PORT || '4040' }}
        TF_VAR_ngrok_url: ${{ vars.NGROK_URL || '' }}
        TF_VAR_ngrok_subdomain: ${{ vars.NGROK_SUBDOMAIN || '' }}
        TF_VAR_log_level: ${{ vars.LOG_LEVEL || 'INFO' }}
        TF_VAR_hot_lead_webhook_url: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}/api/alerts
        TF_VAR_hot_lead_email_recipients: ${{ vars.HOT_LEAD_EMAIL_RECIPIENTS || 'dcaulcrick01@gmail.com' }}
        TF_VAR_rate_limit_per_minute: ${{ vars.RATE_LIMIT_PER_MINUTE || '100' }}
        TF_VAR_rate_limit_burst: ${{ vars.RATE_LIMIT_BURST || '200' }}
        TF_VAR_session_timeout_minutes: ${{ vars.SESSION_TIMEOUT_MINUTES || '60' }}
        TF_VAR_remember_me_days: ${{ vars.REMEMBER_ME_DAYS || '30' }}
        TF_VAR_max_file_size_mb: ${{ vars.MAX_FILE_SIZE_MB || '10' }}
        TF_VAR_allowed_file_types: ${{ vars.ALLOWED_FILE_TYPES || 'csv,xlsx,txt' }}
        TF_VAR_carrental_frontend_domain: ''
        TF_VAR_carrental_api_domain: ''
        TF_VAR_subnet_id: ''
        TF_VAR_route53_zone_id: ''
        TF_VAR_alb_dns_name: ''
        TF_VAR_alb_zone_id: ''
      run: |
        echo "üí• Destroying SMS Seller Connect infrastructure in ${{ env.ENVIRONMENT }}..."
        
        terraform destroy -auto-approve
        
        echo "üóëÔ∏è Destruction completed!"

    - name: Display Destroy Results
      if: always()
      run: |
        echo "#### üí• SMS Seller Connect Infrastructure Destruction Results"
        echo ""
        echo "**Status**: ${{ job.status == 'success' && '‚úÖ Successfully Destroyed' || '‚ùå Destruction Failed' }}"
        echo "**Environment**: ${{ env.ENVIRONMENT }}"
        echo "**Project**: ${{ env.PROJECT_NAME }}"
        echo ""
        echo "${{ job.status == 'success' && '‚ö†Ô∏è **All SMS Seller Connect infrastructure has been destroyed!**' || '‚ùå **Destruction failed - some resources may remain**' }}"
        echo ""
        echo "**Note**: State file preserved in S3 for audit purposes."

  verify-secrets:
    name: 'üîê Verify GitHub Secrets & Variables'
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'verify-secrets'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Verify Required Secrets
      run: |
        echo "üîê Verifying GitHub Secrets and Variables..."
        echo ""
        
        # Track missing secrets/variables
        missing_secrets=()
        missing_vars=()
        
        # Required Secrets
        echo "### Required Secrets:"
        secrets=(
          "AWS_ACCESS_KEY_ID"
          "AWS_SECRET_ACCESS_KEY"
          "SSH_PUBLIC_KEY"
          "DB_HOST"
          "DB_USER"
          "DB_PASSWORD"
          "FLASK_SECRET_KEY"
          "JWT_SECRET_KEY"
          "TWILIO_ACCOUNT_SID"
          "TWILIO_AUTH_TOKEN"
          "TWILIO_PHONE_NUMBER"
          "OPENAI_API_KEY"
          "SENDGRID_API_KEY"
          "NGROK_AUTH_TOKEN"
          "HOT_LEAD_SMS_RECIPIENTS"
        )
        
        for secret in "${secrets[@]}"; do
          case "$secret" in
            "AWS_ACCESS_KEY_ID")
              if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
                echo "‚úÖ $secret - Set (${#{{ secrets.AWS_ACCESS_KEY_ID }}} chars)"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "AWS_SECRET_ACCESS_KEY")
              if [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
                echo "‚úÖ $secret - Set (${#{{ secrets.AWS_SECRET_ACCESS_KEY }}} chars)"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "SSH_PUBLIC_KEY")
              if [ -n "${{ secrets.SSH_PUBLIC_KEY }}" ]; then
                echo "‚úÖ $secret - Set (${#{{ secrets.SSH_PUBLIC_KEY }}} chars)"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "DB_HOST")
              if [ -n "${{ secrets.DB_HOST }}" ]; then
                echo "‚úÖ $secret - Set"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "DB_USER")
              if [ -n "${{ secrets.DB_USER }}" ]; then
                echo "‚úÖ $secret - Set"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "DB_PASSWORD")
              if [ -n "${{ secrets.DB_PASSWORD }}" ]; then
                echo "‚úÖ $secret - Set (${#{{ secrets.DB_PASSWORD }}} chars)"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "FLASK_SECRET_KEY")
              if [ -n "${{ secrets.FLASK_SECRET_KEY }}" ]; then
                echo "‚úÖ $secret - Set (${#{{ secrets.FLASK_SECRET_KEY }}} chars)"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "JWT_SECRET_KEY")
              if [ -n "${{ secrets.JWT_SECRET_KEY }}" ]; then
                echo "‚úÖ $secret - Set (${#{{ secrets.JWT_SECRET_KEY }}} chars)"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "TWILIO_ACCOUNT_SID")
              if [ -n "${{ secrets.TWILIO_ACCOUNT_SID }}" ]; then
                echo "‚úÖ $secret - Set"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "TWILIO_AUTH_TOKEN")
              if [ -n "${{ secrets.TWILIO_AUTH_TOKEN }}" ]; then
                echo "‚úÖ $secret - Set (${#{{ secrets.TWILIO_AUTH_TOKEN }}} chars)"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "TWILIO_PHONE_NUMBER")
              if [ -n "${{ secrets.TWILIO_PHONE_NUMBER }}" ]; then
                echo "‚úÖ $secret - Set"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "OPENAI_API_KEY")
              if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
                echo "‚úÖ $secret - Set (${#{{ secrets.OPENAI_API_KEY }}} chars)"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "SENDGRID_API_KEY")
              if [ -n "${{ secrets.SENDGRID_API_KEY }}" ]; then
                echo "‚úÖ $secret - Set (${#{{ secrets.SENDGRID_API_KEY }}} chars)"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "NGROK_AUTH_TOKEN")
              if [ -n "${{ secrets.NGROK_AUTH_TOKEN }}" ]; then
                echo "‚úÖ $secret - Set (${#{{ secrets.NGROK_AUTH_TOKEN }}} chars)"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
            "HOT_LEAD_SMS_RECIPIENTS")
              if [ -n "${{ secrets.HOT_LEAD_SMS_RECIPIENTS }}" ]; then
                echo "‚úÖ $secret - Set"
              else
                echo "‚ùå $secret - Missing"
                missing_secrets+=("$secret")
              fi
              ;;
          esac
        done
        
        echo ""
        echo "### Required Variables:"
        variables=(
          "BACKEND_IMAGE"
          "FRONTEND_IMAGE"
          "SMS_FRONTEND_DOMAIN"
          "SMS_API_DOMAIN"
          "SENDGRID_FROM_EMAIL"
          "DB_PORT"
          "DB_NAME"
        )
        
        for var in "${variables[@]}"; do
          case "$var" in
            "BACKEND_IMAGE")
              if [ -n "${{ vars.BACKEND_IMAGE }}" ]; then
                echo "‚úÖ $var - ${{ vars.BACKEND_IMAGE }}"
              else
                echo "‚ö†Ô∏è $var - Using fallback: 522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend:latest"
              fi
              ;;
            "FRONTEND_IMAGE")
              if [ -n "${{ vars.FRONTEND_IMAGE }}" ]; then
                echo "‚úÖ $var - ${{ vars.FRONTEND_IMAGE }}"
              else
                echo "‚ö†Ô∏è $var - Using fallback: 522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-frontend:latest"
              fi
              ;;
            "SMS_FRONTEND_DOMAIN")
              if [ -n "${{ vars.SMS_FRONTEND_DOMAIN }}" ]; then
                echo "‚úÖ $var - ${{ vars.SMS_FRONTEND_DOMAIN }}"
              else
                echo "‚ö†Ô∏è $var - Using fallback: sms.typerelations.com"
              fi
              ;;
            "SMS_API_DOMAIN")
              if [ -n "${{ vars.SMS_API_DOMAIN }}" ]; then
                echo "‚úÖ $var - ${{ vars.SMS_API_DOMAIN }}"
              else
                echo "‚ö†Ô∏è $var - Using fallback: api.sms.typerelations.com"
              fi
              ;;
            "SENDGRID_FROM_EMAIL")
              if [ -n "${{ vars.SENDGRID_FROM_EMAIL }}" ]; then
                echo "‚úÖ $var - ${{ vars.SENDGRID_FROM_EMAIL }}"
              else
                echo "‚ö†Ô∏è $var - Using fallback: noreply@typerelations.com"
              fi
              ;;
            "DB_PORT")
              if [ -n "${{ vars.DB_PORT }}" ]; then
                echo "‚úÖ $var - ${{ vars.DB_PORT }}"
              else
                echo "‚ö†Ô∏è $var - Using fallback: 5437"
              fi
              ;;
            "DB_NAME")
              if [ -n "${{ vars.DB_NAME }}" ]; then
                echo "‚úÖ $var - ${{ vars.DB_NAME }}"
              else
                echo "‚ö†Ô∏è $var - Using fallback: sms_blast"
              fi
              ;;
          esac
        done
        
        echo ""
        echo "### Summary:"
        if [ ${#missing_secrets[@]} -eq 0 ] && [ ${#missing_vars[@]} -eq 0 ]; then
          echo "üéâ All required secrets and variables are configured!"
        else
          echo "‚ùå Missing configuration:"
          if [ ${#missing_secrets[@]} -gt 0 ]; then
            echo "Missing secrets: ${missing_secrets[*]}"
          fi
          if [ ${#missing_vars[@]} -gt 0 ]; then
            echo "Missing variables: ${missing_vars[*]}"
          fi
          exit 1
        fi

  redeploy:
    name: 'üöÄ Redeploy Application'
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'redeploy'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Upload Redeployment Script to S3
      working-directory: ${{ env.TF_WORKING_DIR }}
      run: |
        echo "üì§ Uploading redeployment script to S3..."
        aws s3 cp scripts/redeploy-application.sh s3://sms-seller-connect-bucket/scripts/redeploy-application.sh
        echo "‚úÖ Redeployment script uploaded"

    - name: Get EC2 Instance Details
      id: ec2-details
      run: |
        echo "üîç Getting EC2 instance details..."
        
        INSTANCE_ID=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=sms-seller-connect-${{ env.ENVIRONMENT }}-ec2" "Name=instance-state-name,Values=running" \
          --query 'Reservations[0].Instances[0].InstanceId' \
          --output text)
        
        if [ "$INSTANCE_ID" = "None" ] || [ "$INSTANCE_ID" = "null" ]; then
          echo "‚ùå No running EC2 instance found for environment: ${{ env.ENVIRONMENT }}"
          exit 1
        fi
        
        INSTANCE_IP=$(aws ec2 describe-instances \
          --instance-ids "$INSTANCE_ID" \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text)
        
        echo "‚úÖ Found EC2 instance:"
        echo "Instance ID: $INSTANCE_ID"
        echo "Public IP: $INSTANCE_IP"
        
        echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
        echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT

    - name: Execute Redeployment via SSM
      run: |
        echo "üöÄ Executing redeployment on EC2 instance..."
        
        # Create the redeployment command with all environment variables
        COMMAND=$(cat << 'EOF'
        #!/bin/bash
        set -e
        
        # Export all environment variables for the redeployment script
        export AWS_REGION="${{ env.AWS_REGION }}"
        export S3_BUCKET="sms-seller-connect-bucket"
        export ENVIRONMENT="${{ env.ENVIRONMENT }}"
        
        # Docker Images
        export BACKEND_IMAGE="${{ vars.BACKEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-backend:latest' }}"
        export FRONTEND_IMAGE="${{ vars.FRONTEND_IMAGE || '522814698925.dkr.ecr.us-east-1.amazonaws.com/sms-wholesaling-frontend:latest' }}"
        
        # Domain Configuration
        export SMS_API_DOMAIN="${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}"
        export SMS_FRONTEND_DOMAIN="${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}"
        
        # Database Configuration
        export DB_HOST="${{ secrets.DB_HOST }}"
        export DB_PORT="${{ vars.DB_PORT || '5437' }}"
        export DB_NAME="${{ vars.DB_NAME || 'sms_blast' }}"
        export DB_USER="${{ secrets.DB_USER }}"
        export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
        
        # Application Configuration
        export SECRET_KEY="${{ secrets.FLASK_SECRET_KEY }}"
        export JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}"
        export TWILIO_ACCOUNT_SID="${{ secrets.TWILIO_ACCOUNT_SID }}"
        export TWILIO_AUTH_TOKEN="${{ secrets.TWILIO_AUTH_TOKEN }}"
        export TWILIO_PHONE_NUMBER="${{ secrets.TWILIO_PHONE_NUMBER }}"
        export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
        export OPENAI_MODEL="${{ vars.OPENAI_MODEL || 'gpt-4o' }}"
        export OPENAI_TEMPERATURE="${{ vars.OPENAI_TEMPERATURE || '0.3' }}"
        
        # SendGrid Configuration
        export SENDGRID_API_KEY="${{ secrets.SENDGRID_API_KEY }}"
        export SENDGRID_FROM_EMAIL="${{ vars.SENDGRID_FROM_EMAIL || 'noreply@typerelations.com' }}"
        
        # AWS Configuration
        export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
        export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
        export S3_BUCKET_NAME="${{ vars.S3_BUCKET_NAME || 'grey-database-bucket' }}"
        
        # Hot Lead Configuration
        export HOT_LEAD_EMAIL_RECIPIENTS="${{ vars.HOT_LEAD_EMAIL_RECIPIENTS || 'dcaulcrick01@gmail.com' }}"
        export HOT_LEAD_SMS_RECIPIENTS="${{ secrets.HOT_LEAD_SMS_RECIPIENTS }}"
        
        # Rate Limiting
        export RATE_LIMIT_PER_MINUTE="${{ vars.RATE_LIMIT_PER_MINUTE || '100' }}"
        export RATE_LIMIT_BURST="${{ vars.RATE_LIMIT_BURST || '200' }}"
        
        # Session Configuration
        export SESSION_TIMEOUT_MINUTES="${{ vars.SESSION_TIMEOUT_MINUTES || '60' }}"
        export REMEMBER_ME_DAYS="${{ vars.REMEMBER_ME_DAYS || '30' }}"
        
        # File Upload Configuration
        export MAX_FILE_SIZE_MB="${{ vars.MAX_FILE_SIZE_MB || '10' }}"
        export ALLOWED_FILE_TYPES="${{ vars.ALLOWED_FILE_TYPES || 'csv,xlsx,txt' }}"
        
        # Download and execute the redeployment script
        echo "üì• Downloading redeployment script..."
        aws s3 cp s3://sms-seller-connect-bucket/scripts/redeploy-application.sh /tmp/redeploy-application.sh
        chmod +x /tmp/redeploy-application.sh
        
        echo "üöÄ Executing redeployment..."
        /tmp/redeploy-application.sh
        EOF
        )
        
        # Execute the command via SSM
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "${{ steps.ec2-details.outputs.instance_id }}" \
          --document-name "AWS-RunShellScript" \
          --parameters "commands=[\"$COMMAND\"]" \
          --comment "SMS Seller Connect Application Redeployment" \
          --query 'Command.CommandId' \
          --output text)
        
        echo "üìã SSM Command ID: $COMMAND_ID"
        
        # Wait for command to complete
        echo "‚è≥ Waiting for redeployment to complete..."
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ steps.ec2-details.outputs.instance_id }}"
        
        # Get command output
        echo "üìä Redeployment output:"
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ steps.ec2-details.outputs.instance_id }}" \
          --query 'StandardOutputContent' \
          --output text
        
        # Check if command succeeded
        STATUS=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ steps.ec2-details.outputs.instance_id }}" \
          --query 'Status' \
          --output text)
        
        if [ "$STATUS" = "Success" ]; then
          echo "üéâ Redeployment completed successfully!"
        else
          echo "‚ùå Redeployment failed with status: $STATUS"
          echo "Error output:"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.ec2-details.outputs.instance_id }}" \
            --query 'StandardErrorContent' \
            --output text
          exit 1
        fi

    - name: Verify Application Health
      run: |
        echo "üîç Verifying application health..."
        
        # Get ALB DNS name
        ALB_DNS=$(aws elbv2 describe-load-balancers \
          --names "sms-seller-connect-${{ env.ENVIRONMENT }}-alb" \
          --query 'LoadBalancers[0].DNSName' \
          --output text)
        
        if [ "$ALB_DNS" != "None" ] && [ "$ALB_DNS" != "null" ]; then
          echo "üåê Testing ALB health endpoint..."
          
          # Test ALB health endpoint with retries
          for i in {1..10}; do
            if curl -f -s "http://$ALB_DNS/alb-health" > /dev/null; then
              echo "‚úÖ ALB health check passed"
              break
            else
              if [ $i -eq 10 ]; then
                echo "‚ùå ALB health check failed after 10 attempts"
              else
                echo "‚è≥ Attempt $i/10 failed, retrying in 30s..."
                sleep 30
              fi
            fi
          done
        fi
        
        echo "üéâ Application redeployment verification completed!"

    - name: Display Redeployment Results
      if: always()
      run: |
        echo "#### üöÄ SMS Seller Connect Application Redeployment Results"
        echo ""
        echo "**Status**: ${{ job.status == 'success' && '‚úÖ Successfully Redeployed' || '‚ùå Redeployment Failed' }}"
        echo "**Environment**: ${{ env.ENVIRONMENT }}"
        echo "**Instance ID**: ${{ steps.ec2-details.outputs.instance_id }}"
        echo "**Instance IP**: ${{ steps.ec2-details.outputs.instance_ip }}"
        echo ""
        echo "**Frontend URL**: https://${{ vars.SMS_FRONTEND_DOMAIN || 'sms.typerelations.com' }}"
        echo "**API URL**: https://${{ vars.SMS_API_DOMAIN || 'api.sms.typerelations.com' }}"
        echo ""
        echo "${{ job.status == 'success' && 'üéâ **Application has been successfully redeployed without infrastructure changes!**' || '‚ùå **Redeployment failed - check logs for details**' }}"
